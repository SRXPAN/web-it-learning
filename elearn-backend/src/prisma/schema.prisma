datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  name             String
  password         String
  avatarId         String?        // Reference to File
  avatarFile       File?          @relation("UserAvatar", fields: [avatarId], references: [id])
  role             Role           @default(STUDENT)
  xp               Int            @default(0)
  emailVerified    Boolean        @default(false)
  isPremium        Boolean        @default(true) // All users are premium (free version)
  deletedAt        DateTime?      // For soft delete - freed email when deleted
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @default(now()) @updatedAt
  answers          Answer[]
  viewedMaterials  String[]       @default([])
  topicsCreated    Topic[]        @relation("TopicCreator")
  materialsCreated Material[]     @relation("MaterialCreator")
  quizzesCreated   Quiz[]         @relation("QuizCreator")
  quizAttempts     QuizAttempt[]
  refreshTokens    RefreshToken[]
  filesUploaded    File[]         @relation("FileUploader")
  auditLogs        AuditLog[]
  dailyGoals       DailyGoalTemplate[]

  @@index([role])
  @@index([createdAt])
  @@index([email])
  @@index([deletedAt])
}

enum Role {
  STUDENT
  EDITOR
  ADMIN
}

enum Category {
  Programming
  Mathematics
  Databases
  Networks
  WebDevelopment
  MobileDevelopment
  MachineLearning
  Security
  DevOps
  OperatingSystems
}

enum Status {
  Draft
  Published
}

model Topic {
  id          String     @id @default(cuid())
  slug        String     @unique
  name        String // Fallback name (EN) - kept for backward compat
  nameJson    Json? // {"UA": "...", "PL": "...", "EN": "..."}
  titleCache  Json?      // {"UA": "...", "EN": "..."}
  description String
  descJson    Json? // {"UA": "...", "PL": "...", "EN": "..."}
  descCache   Json?      // {"UA": "...", "EN": "..."}
  category    Category   @default(Programming)
  parentId    String?
  parent      Topic?     @relation("TopicTree", fields: [parentId], references: [id])
  children    Topic[]    @relation("TopicTree")
  materials   Material[]
  quizzes     Quiz[]
  status      Status     @default(Draft)
  publishedAt DateTime?
  createdById String?
  createdBy   User?      @relation("TopicCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now()) @updatedAt

  @@index([category])
  @@index([parentId])
}

model Material {
  id            String       @id @default(cuid())
  title         String // Fallback title (EN)
  titleJson     Json? // {"UA": "...", "PL": "...", "EN": "..."}
  titleCache    Json?        // {"UA": "...", "EN": "..."}
  type          MaterialType
  url           String?      // Fallback URL (EN)
  urlJson       Json?        @map("urlCache") // {"UA": "s3/file_ua.pdf", "EN": "s3/file_en.pdf"}
  fileId        String?      // Reference to File for pdf/video/image
  file          File?        @relation(fields: [fileId], references: [id])
  content       String?      // Fallback content (EN)
  contentJson   Json? // {"UA": "...", "PL": "...", "EN": "..."}
  contentCache  Json?        // {"UA": "# Привіт", "EN": "# Hello"}
  lang          Lang         @default(EN) // Primary language of material
  topic         Topic        @relation(fields: [topicId], references: [id])
  topicId       String
  views         Int          @default(0)
  status        Status       @default(Draft)
  publishedAt   DateTime?
  createdById   String?
  createdBy     User?        @relation("MaterialCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @default(now()) @updatedAt
  deletedAt     DateTime?

  @@index([topicId])
}

enum Lang {
  UA
  PL
  EN
}

enum MaterialType {
  pdf
  video
  link
  text
}

model Quiz {
  id            String        @id @default(cuid())
  title         String // Fallback title (EN)
  titleJson     Json? // {"UA": "...", "PL": "...", "EN": "..."}
  titleCache    Json?         // {"UA": "...", "EN": "..."}
  durationSec   Int           @default(60)
  topicId       String
  topic         Topic         @relation(fields: [topicId], references: [id], onDelete: Cascade)
  questions     Question[]
  attempts      QuizAttempt[]
  status        Status        @default(Draft)
  publishedAt   DateTime?
  createdById   String?
  createdBy     User?         @relation("QuizCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @default(now()) @updatedAt
  deletedAt     DateTime?

  @@index([topicId])
}

model Question {
  id                 String     @id @default(cuid())
  text               String // Fallback text (EN)
  textJson           Json? // {"UA": "...", "PL": "...", "EN": "..."}
  explanation        String?
  explanationJson    Json? // {"UA": "...", "PL": "...", "EN": "..."}
  tags               String[]
  difficulty         Difficulty
  quizId             String
  quiz               Quiz       @relation(fields: [quizId], references: [id])
  options            Option[]
  answers            Answer[]

  @@index([quizId])
}

model Option {
  id           String   @id @default(cuid())
  text         String // Fallback text (EN)
  textJson     Json? // {"UA": "...", "PL": "...", "EN": "..."}
  correct      Boolean  @default(false)
  questionId   String
  question     Question @relation(fields: [questionId], references: [id])
  answers      Answer[]

  @@index([questionId])
}

model Answer {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  questionId String
  question   Question @relation(fields: [questionId], references: [id])
  optionId   String?
  option     Option?  @relation(fields: [optionId], references: [id])
  isCorrect  Boolean
  createdAt  DateTime @default(now())
  attemptId  String?
  attempt    QuizAttempt? @relation(fields: [attemptId], references: [id])

  @@index([userId])
  @@index([questionId])
  @@index([userId, questionId]) // Композитний індекс для швидкого пошуку відповідей користувача
  @@index([createdAt]) // Індекс для сортування за датою
  @@index([attemptId])
}

model QuizAttempt {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  quizId    String
  quiz      Quiz     @relation(fields: [quizId], references: [id])
  score     Int      // correct answers count
  total     Int      // total questions
  xpEarned  Int      @default(0)
  createdAt DateTime @default(now())
  answers   Answer[]

  @@index([userId])
  @@index([quizId])
  @@index([userId, createdAt])
}

enum Difficulty {
  Easy
  Medium
  Hard
}

model Payment {
  id         String   @id @default(cuid())
  userEmail  String
  amount     Int
  currency   String
  provider   String
  providerId String
  status     String
  createdAt  DateTime @default(now())
}

model InviteToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

// ============================================
// SESSION & AUTH MODELS
// ============================================

// Refresh токени для безпечної автентифікації
model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userAgent String?
  ip        String?
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// Токени для скидання паролю
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

// Токени для верифікації email
model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

// ============================================
// ACTIVITY & PROGRESS MODELS
// ============================================

// Переглянуті матеріали (замість масиву в User)
model MaterialView {
  id         String   @id @default(cuid())
  userId     String
  materialId String
  viewedAt   DateTime @default(now())
  timeSpent  Int? // Час перегляду в секундах

  @@unique([userId, materialId])
  @@index([userId])
  @@index([materialId])
  @@index([viewedAt])
}

// Активність користувача (для аналітики)
model UserActivity {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @db.Date // Тільки дата без часу
  timeSpent       Int      @default(0) // Час в секундах
  quizAttempts    Int      @default(0)
  materialsViewed Int      @default(0)
  goalsCompleted  Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// ============================================
// TRANSLATION MODELS
// ============================================

// Версіонування перекладів для кешування (ETag)
model TranslationVersion {
  id        String   @id @default(cuid())
  namespace String   @unique // "common", "auth", "quiz", etc.
  version   Int      @default(1)
  updatedAt DateTime @default(now()) @updatedAt
}

// UI переклади (кнопки, меню, повідомлення)
model UiTranslation {
  id           String   @id @default(cuid())
  key          String   @unique // "nav.dashboard", "quiz.title", etc.
  namespace    String   @default("common") // common, auth, quiz, materials, editor, dashboard
  translations Json     // {"UA": "...", "PL": "...", "EN": "..."}
  description  String?  // Опис для редактора перекладів
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  @@index([key])
  @@index([namespace])
}

// ============================================
// I18N TABLES REMOVED - Using JSON Cache Fields
// ============================================
// The normalized I18nKey/I18nValue tables have been removed.
// Localization now uses JSON cache fields directly in Topic/Material/Quiz:
// - titleCache: {"UA": "...", "EN": "...", "PL": "..."}
// - urlJson, contentCache, descCache (similar structure)

// Щоденні цілі з перекладами
model DailyGoalTemplate {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  date        String   // Формат "YYYY-MM-DD"
  templateId  String   // Наприклад "g1", "g15" з твого файлу
  isCompleted Boolean  @default(false)
  progress    Int      @default(0) // Якщо ціль "пройти 3 квізи", тут буде 1, 2 або 3

  @@unique([userId, date, templateId])
}

// Слабкі місця / рекомендації
model WeakSpotTemplate {
  id           String   @id @default(cuid())
  category     String // algorithms, sql, oop, etc.
  weight       Int      @default(1)
  translations Json // {topic: {UA,PL,EN}, advice: {UA,PL,EN}}
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt
}

// Досягнення
model AchievementTemplate {
  id           String   @id @default(cuid())
  code         String   @unique // "first_quiz", "week_streak", etc.
  icon         String // emoji or icon name
  translations Json // {name: {UA,PL,EN}, description: {UA,PL,EN}}
  xpReward     Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt
}

// Категорії з перекладами
model CategoryTranslation {
  id           String   @id @default(cuid())
  category     Category @unique
  translations Json // {"UA": "Програмування", "PL": "...", "EN": "..."}
}

// ============================================
// FILE STORAGE MODELS
// ============================================

// Файли (S3/R2 storage metadata)
model File {
  id           String       @id @default(cuid())
  key          String       @unique // S3 key: "files/abc123.pdf"
  bucket       String       @default("elearn-files")
  originalName String       // Original filename
  mimeType     String       // "application/pdf", "image/jpeg", etc.
  size         Int          // Size in bytes
  visibility   Visibility   @default(PRIVATE)
  uploadedById String?
  uploadedBy   User?        @relation("FileUploader", fields: [uploadedById], references: [id], onDelete: SetNull)
  materials    Material[]
  userAvatars  User[]       @relation("UserAvatar")
  confirmed    Boolean      @default(false) // True after upload confirmed
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @default(now()) @updatedAt

  @@index([uploadedById])
  @@index([visibility])
  @@index([mimeType])
}

enum Visibility {
  PUBLIC
  PRIVATE
  SIGNED // Requires signed URL
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String   // "CREATE", "UPDATE", "DELETE", "LOGIN", "LOGOUT"
  resource   String   // "topic", "material", "quiz", "user", "file"
  resourceId String?
  metadata   Json?    // Additional context
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}
