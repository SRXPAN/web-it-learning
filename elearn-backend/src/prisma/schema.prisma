datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  name             String
  password         String
  avatarId         String?        // Reference to File
  avatarFile       File?          @relation("UserAvatar", fields: [avatarId], references: [id])
  role             Role           @default(STUDENT)
  xp               Int            @default(0)
  emailVerified    Boolean        @default(false)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @default(now()) @updatedAt
  answers          Answer[]
  viewedMaterials  String[]       @default([])
  topicsCreated    Topic[]        @relation("TopicCreator")
  materialsCreated Material[]     @relation("MaterialCreator")
  quizzesCreated   Quiz[]         @relation("QuizCreator")
  quizAttempts     QuizAttempt[]
  refreshTokens    RefreshToken[]
  filesUploaded    File[]         @relation("FileUploader")
  auditLogs        AuditLog[]

  @@index([role])
  @@index([createdAt])
  @@index([email])
}

enum Role {
  STUDENT
  EDITOR
  ADMIN
}

enum Category {
  Programming
  Mathematics
  Databases
  Networks
  WebDevelopment
  MobileDevelopment
  MachineLearning
  Security
  DevOps
  OperatingSystems
}

enum Status {
  Draft
  Published
}

model Topic {
  id          String     @id @default(cuid())
  slug        String     @unique
  name        String // Fallback name (EN) - kept for backward compat
  nameJson    Json? // {"UA": "...", "PL": "...", "EN": "..."} - legacy, use titleKey
  titleKeyId  String?    // Reference to I18nKey for localized title
  titleKey    I18nKey?   @relation("TopicTitle", fields: [titleKeyId], references: [id])
  description String
  descJson    Json? // {"UA": "...", "PL": "...", "EN": "..."} - legacy, use descKey
  descKeyId   String?    // Reference to I18nKey for localized description
  descKey     I18nKey?   @relation("TopicDesc", fields: [descKeyId], references: [id])
  category    Category   @default(Programming)
  parentId    String?
  parent      Topic?     @relation("TopicTree", fields: [parentId], references: [id])
  children    Topic[]    @relation("TopicTree")
  materials   Material[]
  quizzes     Quiz[]
  status      Status     @default(Draft)
  publishedAt DateTime?
  createdById String?
  createdBy   User?      @relation("TopicCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now()) @updatedAt

  @@index([category])
  @@index([parentId])
  @@index([titleKeyId])
  @@index([descKeyId])
}

model Material {
  id            String       @id @default(cuid())
  title         String // Fallback title (EN)
  titleJson     Json? // {"UA": "...", "PL": "...", "EN": "..."} - legacy, use titleKey
  titleKeyId    String?      // Reference to I18nKey for localized title
  titleKey      I18nKey?     @relation("MaterialTitle", fields: [titleKeyId], references: [id])
  type          MaterialType
  url           String?
  fileId        String?      // Reference to File for pdf/video/image
  file          File?        @relation(fields: [fileId], references: [id])
  content       String?
  contentJson   Json? // {"UA": "...", "PL": "...", "EN": "..."} - legacy, use contentKey
  contentKeyId  String?      // Reference to I18nKey for localized content
  contentKey    I18nKey?     @relation("MaterialContent", fields: [contentKeyId], references: [id])
  lang          Lang         @default(EN) // Primary language of material
  topic         Topic        @relation(fields: [topicId], references: [id])
  topicId       String
  views         Int          @default(0)
  status        Status       @default(Draft)
  publishedAt   DateTime?
  createdById   String?
  createdBy     User?        @relation("MaterialCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @default(now()) @updatedAt

  @@index([topicId])
  @@index([titleKeyId])
  @@index([contentKeyId])
}

enum Lang {
  UA
  PL
  EN
}

enum MaterialType {
  pdf
  video
  link
  text
}

model Quiz {
  id            String        @id @default(cuid())
  title         String // Fallback title (EN)
  titleJson     Json? // {"UA": "...", "PL": "...", "EN": "..."} - legacy, use titleKey
  titleKeyId    String?       // Reference to I18nKey for localized title
  titleKey      I18nKey?      @relation("QuizTitle", fields: [titleKeyId], references: [id])
  durationSec   Int           @default(60)
  topicId       String
  topic         Topic         @relation(fields: [topicId], references: [id], onDelete: Cascade)
  questions     Question[]
  attempts      QuizAttempt[]
  status        Status        @default(Draft)
  publishedAt   DateTime?
  createdById   String?
  createdBy     User?         @relation("QuizCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @default(now()) @updatedAt

  @@index([topicId])
  @@index([titleKeyId])
}

model Question {
  id                 String     @id @default(cuid())
  text               String // Fallback text (EN)
  textJson           Json? // {"UA": "...", "PL": "...", "EN": "..."} - legacy, use textKey
  textKeyId          String?    // Reference to I18nKey for localized question text
  textKey            I18nKey?   @relation("QuestionText", fields: [textKeyId], references: [id])
  explanation        String?
  explanationJson    Json? // {"UA": "...", "PL": "...", "EN": "..."} - legacy, use explanationKey
  explanationKeyId   String?    // Reference to I18nKey for localized explanation
  explanationKey     I18nKey?   @relation("QuestionExplanation", fields: [explanationKeyId], references: [id])
  tags               String[]
  difficulty         Difficulty
  quizId             String
  quiz               Quiz       @relation(fields: [quizId], references: [id])
  options            Option[]
  answers            Answer[]

  @@index([quizId])
  @@index([textKeyId])
  @@index([explanationKeyId])
}

model Option {
  id           String   @id @default(cuid())
  text         String // Fallback text (EN)
  textJson     Json? // {"UA": "...", "PL": "...", "EN": "..."} - legacy, use textKey
  textKeyId    String?  // Reference to I18nKey for localized option text
  textKey      I18nKey? @relation("OptionText", fields: [textKeyId], references: [id])
  correct      Boolean  @default(false)
  questionId   String
  question     Question @relation(fields: [questionId], references: [id])
  answers      Answer[]

  @@index([questionId])
  @@index([textKeyId])
}

model Answer {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  questionId String
  question   Question @relation(fields: [questionId], references: [id])
  optionId   String?
  option     Option?  @relation(fields: [optionId], references: [id])
  isCorrect  Boolean
  createdAt  DateTime @default(now())
  attemptId  String?
  attempt    QuizAttempt? @relation(fields: [attemptId], references: [id])

  @@index([userId])
  @@index([questionId])
  @@index([userId, questionId]) // Композитний індекс для швидкого пошуку відповідей користувача
  @@index([createdAt]) // Індекс для сортування за датою
  @@index([attemptId])
}

model QuizAttempt {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  quizId    String
  quiz      Quiz     @relation(fields: [quizId], references: [id])
  score     Int      // correct answers count
  total     Int      // total questions
  xpEarned  Int      @default(0)
  createdAt DateTime @default(now())
  answers   Answer[]

  @@index([userId])
  @@index([quizId])
  @@index([userId, createdAt])
}

enum Difficulty {
  Easy
  Medium
  Hard
}

model Payment {
  id         String   @id @default(cuid())
  userEmail  String
  amount     Int
  currency   String
  provider   String
  providerId String
  status     String
  createdAt  DateTime @default(now())
}

model InviteToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

// ============================================
// SESSION & AUTH MODELS
// ============================================

// Refresh токени для безпечної автентифікації
model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userAgent String?
  ip        String?
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// Токени для скидання паролю
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

// Токени для верифікації email
model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

// ============================================
// ACTIVITY & PROGRESS MODELS
// ============================================

// Переглянуті матеріали (замість масиву в User)
model MaterialView {
  id         String   @id @default(cuid())
  userId     String
  materialId String
  viewedAt   DateTime @default(now())
  timeSpent  Int? // Час перегляду в секундах

  @@unique([userId, materialId])
  @@index([userId])
  @@index([materialId])
  @@index([viewedAt])
}

// Активність користувача (для аналітики)
model UserActivity {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @db.Date // Тільки дата без часу
  timeSpent       Int      @default(0) // Час в секундах
  quizAttempts    Int      @default(0)
  materialsViewed Int      @default(0)
  goalsCompleted  Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// ============================================
// TRANSLATION MODELS
// ============================================

// Версіонування перекладів для кешування (ETag)
model TranslationVersion {
  id        String   @id @default(cuid())
  namespace String   @unique // "common", "auth", "quiz", etc.
  version   Int      @default(1)
  updatedAt DateTime @default(now()) @updatedAt
}

// UI переклади (кнопки, меню, повідомлення)
model UiTranslation {
  id           String   @id @default(cuid())
  key          String   @unique // "nav.dashboard", "quiz.title", etc.
  namespace    String   @default("common") // common, auth, quiz, materials, editor, dashboard
  translations Json     // {"UA": "...", "PL": "...", "EN": "..."}
  description  String?  // Опис для редактора перекладів
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  @@index([key])
  @@index([namespace])
}

// ============================================
// NORMALIZED I18N TABLES
// ============================================

// Ключі перекладів (нормалізована структура)
model I18nKey {
  id                   String       @id @default(cuid())
  key                  String       // "nav.dashboard", "quiz.title"
  namespace            String       @default("common") // common, auth, quiz, nav, etc.
  description          String?      // Опис для редактора перекладів
  values               I18nValue[]
  // Relations for content localization
  topicTitles          Topic[]      @relation("TopicTitle")
  topicDescs           Topic[]      @relation("TopicDesc")
  materialTitles       Material[]   @relation("MaterialTitle")
  materialContents     Material[]   @relation("MaterialContent")
  quizTitles           Quiz[]       @relation("QuizTitle")
  questionTexts        Question[]   @relation("QuestionText")
  questionExplanations Question[]   @relation("QuestionExplanation")
  optionTexts          Option[]     @relation("OptionText")
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @default(now()) @updatedAt

  @@unique([namespace, key])
  @@index([namespace])
  @@index([key])
}

// Значення перекладів по мовах
model I18nValue {
  id        String   @id @default(cuid())
  keyId     String
  key       I18nKey  @relation(fields: [keyId], references: [id], onDelete: Cascade)
  lang      Lang     // UA, PL, EN
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([keyId, lang])
  @@index([keyId])
  @@index([lang])
}

// Щоденні цілі з перекладами
model DailyGoalTemplate {
  id           String   @id @default(cuid())
  category     String // quiz, materials, learning, practice, review
  weight       Int      @default(1)
  translations Json // {"UA": "...", "PL": "...", "EN": "..."}
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt
}

// Слабкі місця / рекомендації
model WeakSpotTemplate {
  id           String   @id @default(cuid())
  category     String // algorithms, sql, oop, etc.
  weight       Int      @default(1)
  translations Json // {topic: {UA,PL,EN}, advice: {UA,PL,EN}}
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt
}

// Досягнення
model AchievementTemplate {
  id           String   @id @default(cuid())
  code         String   @unique // "first_quiz", "week_streak", etc.
  icon         String // emoji or icon name
  translations Json // {name: {UA,PL,EN}, description: {UA,PL,EN}}
  xpReward     Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt
}

// Категорії з перекладами
model CategoryTranslation {
  id           String   @id @default(cuid())
  category     Category @unique
  translations Json // {"UA": "Програмування", "PL": "...", "EN": "..."}
}

// ============================================
// FILE STORAGE MODELS
// ============================================

// Файли (S3/R2 storage metadata)
model File {
  id           String       @id @default(cuid())
  key          String       @unique // S3 key: "files/abc123.pdf"
  bucket       String       @default("elearn-files")
  originalName String       // Original filename
  mimeType     String       // "application/pdf", "image/jpeg", etc.
  size         Int          // Size in bytes
  visibility   Visibility   @default(PRIVATE)
  uploadedById String?
  uploadedBy   User?        @relation("FileUploader", fields: [uploadedById], references: [id], onDelete: SetNull)
  materials    Material[]
  userAvatars  User[]       @relation("UserAvatar")
  confirmed    Boolean      @default(false) // True after upload confirmed
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @default(now()) @updatedAt

  @@index([uploadedById])
  @@index([visibility])
  @@index([mimeType])
}

enum Visibility {
  PUBLIC
  PRIVATE
  SIGNED // Requires signed URL
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String   // "CREATE", "UPDATE", "DELETE", "LOGIN", "LOGOUT"
  resource   String   // "topic", "material", "quiz", "user", "file"
  resourceId String?
  metadata   Json?    // Additional context
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}
